name: ðŸš€ Continuous Delivery Workflow
run-name: >-
    ${{ github.event_name == 'pull_request' 
              && github.event.pull_request.merged == true 
              && format('Pull Request merged - #{0} workflow run', github.event.pull_request.number) 
      || github.event_name == 'push' 
              && startsWith(github.ref, 'refs/tags/') 
              && format('Tag Created - {0} workflow run', github.ref_name) 
      || github.event_name == 'workflow_dispatch'
              && format('Manual CD Workflow run on {0}', github.ref_name)
      || 'Workflow Run' 
      }}

on:
    pull_request:
        types: [closed]
        branches:
            - main
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            ref:
                description: 'Branch or tag to deploy'
                required: true
                type: string
                default: 'main'

jobs:
    service-delivery:
        name: ðŸ“¦ Service Deployment
        uses: goyalu/.github/.github/workflows/service-delivery.yml@main
        with:
            ref: ${{ github.event.inputs.ref || github.ref }}
        secrets:
            GH_TOKEN: ${{ secrets.GH_TOKEN }}
            CF_API_TOKEN_QA: ${{ secrets.CF_API_TOKEN_QA }}
            TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL_QA }}

    # ============================================================================
    # INTEGRATION TEST SUITE
    # Runs API V1, API V2, MCP, Identity, and Vault tests via reusable workflow
    # ============================================================================
    integration-test-suite:
        name: 'ðŸ§ª Integration Test Suite'
        needs: [service-delivery]
        if: ${{ needs.service-delivery.result == 'success' }}
        uses: goyalu/.github/.github/workflows/integration-test-suite.yml@main
        with:
            environment: 'qa'
            commit_info: ${{ github.sha }}
            run_service_tests: true
            run_vault_tests: true
        secrets:
            GH_TOKEN: ${{ secrets.GH_TOKEN }}
            TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL_QA }}
            APP_ID: ${{ secrets.QA_APP_ID }}
            CF_API_TOKEN_QA: ${{ secrets.CF_API_TOKEN_QA }}
            CF_ACC_ID_QA: ${{ secrets.CF_ACC_ID_QA }}
            CF_R2_TOKEN_CORP: ${{ secrets.CF_R2_TOKEN_CORP }}
            CF_ACC_ID_CORP: ${{ secrets.CF_ACC_ID_CORP }}
